{% extends "coresite/base.html" %}
{% load jsonld seo_tags %}

{% block meta %}
  {% with meta_title=post.meta_title meta_description=post.meta_description|default:post.excerpt|default:'A blog post on Technofatty.' og_type='article' og_image_url=post.og_image_url %}
    {% include "coresite/partials/seo/meta_head.html" %}
  {% endwith %}
  {% if post.date %}<meta property="article:published_time" content="{{ post.date|date:'c' }}">{% endif %}
  {% if post.updated %}<meta property="article:modified_time" content="{{ post.updated|date:'c' }}">{% endif %}
{% endblock %}

{% block structured_data %}
  {{ block.super }}
  {% canonical_url canonical_url as resolved_canonical %}
  {% include "coresite/partials/seo/blog_post_jsonld.html" with post=post canonical_url=resolved_canonical blog_label=blog_label %}
{% endblock %}

{% block content %}
  <section class="section section--scaffold" aria-labelledby="{{ page_id }}-heading">
    <div class="wrap">
        <div class="scaffold__body">
          {% include "coresite/partials/global/status_placeholder.html" %}
          {% include "coresite/partials/global/breadcrumbs.html" with crumbs=breadcrumbs %}
          <h1 id="{{ page_id }}-heading">{{ page_title }}</h1>
          <p class="post-meta">
            <time datetime="{{ post.date|date:'Y-m-d' }}">{{ post.date|date:'d M Y' }}</time> ·
            <a href="{% url 'blog_category' post.category.slug %}">{{ post.category.title }}</a> ·
            {% for tag in post.tags %}<a href="{% url 'blog_tag' tag.slug %}">#{{ tag.title }}</a>{% if not forloop.last %} {% endif %}{% endfor %}
          </p>
          <nav class="post-outline" aria-label="In this post"></nav>
          <article class="post-body"></article>
          {% if post.primary_goal == 'newsletter' %}
            {% include "coresite/partials/newsletter_block.html" with analytics_meta=primary_goal_meta %}
          {% endif %}
          <p class="post-taxonomy">Filed under <a href="{% url 'blog_category' post.category.slug %}">{{ post.category.title }}</a> · {% for tag in post.tags %}<a href="{% url 'blog_tag' tag.slug %}">#{{ tag.title }}</a>{% if not forloop.last %} {% endif %}{% endfor %}</p>
        </div>
        {% include "coresite/partials/_related_discussions.html" %}
      </div>
  </section>
  {% endblock %}

{% block body_scripts %}
  {{ block.super }}
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      var slug = '{{ post.slug|escapejs }}';
      var viewSent = false;
      function sendView() {
        if (window.tfSend && !viewSent) {
          viewSent = true;
          window.tfSend('blog_post_view', { post: slug });
        }
      }
      sendView();
      document.addEventListener('tf:consent-updated', sendView);

      var article = document.querySelector('.post-body');
      if (article) {
        function isOnSite(pathPrefix, href) {
          try {
            var u = new URL(href, window.location.origin);
            return u.origin === window.location.origin && u.pathname.startsWith(pathPrefix);
          } catch (e) {
            return false;
          }
        }
        article.querySelectorAll('a').forEach(function (link) {
          var href = link.getAttribute('href') || '';
          if (link.dataset.analyticsEvent) return;
          if (link.dataset.blogCta !== undefined) {
            link.dataset.analyticsEvent = 'blog_cta_click';
            link.dataset.analyticsMeta = JSON.stringify({ post: slug, target: href, utm: location.search.slice(1) });
          } else if (isOnSite('/tools/', href)) {
            link.dataset.analyticsEvent = 'blog_click_tool';
            link.dataset.analyticsMeta = JSON.stringify({ post: slug, target: href });
          } else if (isOnSite('/knowledge/', href)) {
            link.dataset.analyticsEvent = 'blog_click_article';
            link.dataset.analyticsMeta = JSON.stringify({ post: slug, target: href });
          }
        });
      }

      var fired = { start: false, mid: false, end: false };
      function tick() {
        if (!article || !window.tfSend) return;
        var total = article.scrollHeight || article.offsetHeight || 0;
        if (!total) return;
        var top = article.getBoundingClientRect().top + window.scrollY;
        var seen = Math.max(0, (window.scrollY + window.innerHeight - top));
        var progress = seen / total;

        if (progress > 0 && !fired.start) {
          fired.start = true;
          window.tfSend('blog_read_start', { post: slug });
        }
        if (progress >= 0.5 && !fired.mid) {
          fired.mid = true;
          window.tfSend('blog_read_50', { post: slug });
        }
        if (progress >= 0.95 && !fired.end) {
          fired.end = true;
          window.tfSend('blog_read_95', { post: slug });
          off();
        }
      }
      var scheduled = false;
      function onScroll() {
        if (!scheduled) {
          scheduled = true;
          requestAnimationFrame(function () {
            scheduled = false;
            tick();
          });
        }
      }
      function on() {
        document.addEventListener('scroll', onScroll, { passive: true });
      }
      function off() {
        document.removeEventListener('scroll', onScroll);
      }
      on();
      tick();
    });
  </script>
{% endblock %}
