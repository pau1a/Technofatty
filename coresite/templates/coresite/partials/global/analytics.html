{# See docs/structured-data.md#global-analytics for context keys #}
{% if ANALYTICS_PROVIDER == 'plausible' and ANALYTICS_SITE_ID %}
  <script defer data-domain="{{ ANALYTICS_SITE_ID }}" src="https://plausible.io/js/script.js"></script>
{% elif ANALYTICS_PROVIDER == 'ga4' and ANALYTICS_SITE_ID %}
  <script async src="https://www.googletagmanager.com/gtag/js?id={{ ANALYTICS_SITE_ID }}"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', '{{ ANALYTICS_SITE_ID }}');
  </script>
{% endif %}
{% if ANALYTICS_PROVIDER == 'plausible' or ANALYTICS_PROVIDER == 'ga4' %}
  <script>
    (function(){
      var body=document.body;
      var p=body.dataset.analyticsProvider;
      var enabled=(body.dataset.analyticsEnabled||'true')==='true';
      function hasConsent(){return body.dataset.consentRequired!=='true'||body.dataset.consentGranted==='true';}
      function isActive(){return enabled&&hasConsent();}
      function log(kind,data){
        if(window.logAggregator&&typeof window.logAggregator[kind]==='function'){
          window.logAggregator[kind](data);
        } else if(window.console&&typeof window.console[kind]==='function'){
          window.console[kind](data);
        }
      }
      function send(n,m){
        if(!isActive())return;
        m=m||{};
        try{
          if(p==='plausible'&&window.plausible){
            window.plausible(n,{props:m});
            log('info',{event:n,meta:m,provider:p,ok:true});
          } else if(p==='ga4'&&window.gtag){
            window.gtag('event',n,m);
            log('info',{event:n,meta:m,provider:p,ok:true});
          } else {
            log('warn',{event:n,meta:m,provider:p,ok:false,reason:'provider-missing'});
          }
        } catch(e){
          log('error',{event:n,meta:m,provider:p,ok:false,error:e.toString()});
        }
      }
      if (isActive()) { window.tfSend = send; }
      document.addEventListener('tf:consent-updated',function(){
        if(isActive()&&!window.tfSend){window.tfSend=send;}
      });
      var fired={};
      function meta(el){try{return JSON.parse(el.dataset.analyticsMeta||'{}')}catch(e){return {};}}
      document.addEventListener('click',function(e){var el=e.target;
        while(el){var n=el.dataset&&el.dataset.analyticsEvent;if(n){send(n,meta(el));break;}el=el.parentElement;}});
      document.addEventListener('submit',function(e){var el=e.target,n=el.dataset.analyticsEvent;
        if(n){if(el.checkValidity&&!el.checkValidity())return;send(n,meta(el));}});
      document.addEventListener('focusin',function(e){var el=e.target,n=el.dataset.analyticsEvent;
        if(n&&!fired[n]){fired[n]=1;send(n,meta(el));}});
    })();
  </script>
{% endif %}
